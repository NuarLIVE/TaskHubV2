# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ—Ç–ª–∞–¥–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ AdminSettings –≤–æ–∑–º–æ–∂–Ω–∞ –æ—à–∏–±–∫–∞ –∏–∑-–∑–∞ RLS –ø–æ–ª–∏—Ç–∏–∫.

## ‚úÖ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### 1. –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è?

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Supabase Dashboard:
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∞
SELECT policyname, qual, with_check 
FROM pg_policies 
WHERE schemaname = 'public' 
  AND tablename = 'profiles'
  AND policyname = 'Admins can update user roles';
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π. –ï—Å–ª–∏ –ø—É—Å—Ç–æ - –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞.

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é

–ï—Å–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:

```sql
-- –§–∞–π–ª: supabase/migrations/20251113135339_add_admin_update_role_policy.sql

CREATE POLICY "Admins can update user roles"
  ON profiles
  FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'ADMIN'
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'ADMIN'
    )
  );
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ—é —Ä–æ–ª—å
SELECT id, email, role 
FROM profiles 
WHERE id = auth.uid();
```

–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Ä–æ–ª—å `ADMIN`.

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –Ω—É–∂–Ω—ã–º email
SELECT id, email, role 
FROM profiles 
WHERE email = 'email@example.com';
```

## üîß –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è

```typescript
const handleAddAdmin = async () => {
  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞
  if (!newAdminEmail.trim()) {
    setMessage('–í–≤–µ–¥–∏—Ç–µ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    return;
  }

  // 2. –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
  const { data: profile, error: selectError } = await supabase
    .from('profiles')
    .select('*')
    .eq('email', newAdminEmail.trim())
    .maybeSingle();

  // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
  if (!profile) {
    setMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }

  // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∞–¥–º–∏–Ω –ª–∏ —É–∂–µ
  if (profile.role === 'ADMIN') {
    setMessage('–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
    return;
  }

  // 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ (—Ç—Ä–µ–±—É–µ—Ç RLS –ø–æ–ª–∏—Ç–∏–∫—É)
  const { error: updateError } = await supabase
    .from('profiles')
    .update({ role: 'ADMIN' })
    .eq('id', profile.id);

  if (updateError) {
    console.error('Error updating role:', updateError);
    setMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–æ–ª–∏: ' + updateError.message);
    return;
  }

  setMessage('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');
};
```

## üêõ –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞: "new row violates row-level security policy"

**–ü—Ä–∏—á–∏–Ω–∞:** RLS –ø–æ–ª–∏—Ç–∏–∫–∞ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∏–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é (—Å–º. –ø.2 –≤—ã—à–µ)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã –∞–¥–º–∏–Ω (—Å–º. –ø.3)

### –û—à–∏–±–∫–∞: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ.

### –û—à–∏–±–∫–∞: "–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"

**–ü—Ä–∏—á–∏–Ω–∞:** –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ —Ä–æ–ª—å ADMIN.

**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ø—Ä–æ—Å—Ç–æ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —Å –Ω–æ–≤—ã–º email (–Ω–∞–ø—Ä–∏–º–µ—Ä: `test@example.com`)
2. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email
3. –í–æ–π–¥–∏—Ç–µ –∏ –≤—ã–π–¥–∏—Ç–µ

### –®–∞–≥ 2: –í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω

1. –í–æ–π–¥–∏—Ç–µ —Å –∞–¥–º–∏–Ω—Å–∫–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞

1. –í–≤–µ–¥–∏—Ç–µ email —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `test@example.com`
2. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å"
3. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω"
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î

```sql
SELECT id, email, role, name
FROM profiles
WHERE role = 'ADMIN'
ORDER BY created_at;
```

## üìã –ß–µ–∫-–ª–∏—Å—Ç –æ—Ç–ª–∞–¥–∫–∏

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è `20251113135339_add_admin_update_role_policy.sql` –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [ ] –ü–æ–ª–∏—Ç–∏–∫–∞ "Admins can update user roles" —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î
- [ ] –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Ä–æ–ª—å ADMIN
- [ ] –¶–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ
- [ ] –¶–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –∞–¥–º–∏–Ω
- [ ] –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –Ω–µ—Ç –æ—à–∏–±–æ–∫ RLS

## üîç –û—Ç–ª–∞–¥–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É Console
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
4. –°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –ª–æ–≥–∏:
   - `Error fetching profile:` - –æ—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - `Error updating role:` - –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–æ–ª–∏ (RLS –ø—Ä–æ–±–ª–µ–º–∞)

## üí° –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏

```sql
-- –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è profiles
SELECT policyname, cmd, qual, with_check
FROM pg_policies
WHERE schemaname = 'public' 
  AND tablename = 'profiles'
  AND cmd = 'UPDATE'
ORDER BY policyname;
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º:
- `Users can update own profile` - –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `Admins can update user roles` - –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 2: –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å RLS (–ù–ï –¥–ª—è production!)

```sql
-- –í–ù–ò–ú–ê–ù–ò–ï: –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!
ALTER TABLE profiles DISABLE ROW LEVEL SECURITY;

-- –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ:
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
```

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è RLS –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø—Ä–æ–±–ª–µ–º–∞ —Ç–æ—á–Ω–æ –≤ –ø–æ–ª–∏—Ç–∏–∫–∞—Ö.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É

```sql
-- –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é
DROP POLICY IF EXISTS "Admins can update user roles" ON profiles;

-- –°–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ
CREATE POLICY "Admins can update user roles"
  ON profiles
  FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'ADMIN'
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'ADMIN'
    )
  );
```

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:
1. –°–æ–æ–±—â–µ–Ω–∏–µ: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω"
2. Email –ø–æ–ª–µ –æ—á–∏—â–∞–µ—Ç—Å—è
3. –ù–æ–≤—ã–π –∞–¥–º–∏–Ω –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –Ω–∏–∂–µ
4. Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Supabase Dashboard
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–æ–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
