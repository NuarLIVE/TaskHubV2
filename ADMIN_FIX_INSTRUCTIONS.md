# Исправление функционала добавления администраторов

## Проблема
При попытке добавить администратора через интерфейс AdminSettings изменения не применялись из-за отсутствия правильной RLS политики.

## Решение

### 1. Применить миграцию БД

Найдите и примените миграцию:
```bash
# Миграция находится в:
supabase/migrations/[timestamp]_add_admin_update_role_policy.sql
```

Эта миграция добавляет политику, позволяющую администраторам обновлять роли других пользователей.

### 2. Что было исправлено в коде

**AdminSettings.tsx:**
- ✅ Улучшена обработка ошибок в `handleAddAdmin()`
- ✅ Добавлена валидация email перед запросом
- ✅ Используется `.maybeSingle()` вместо `.single()`
- ✅ Правильная обработка `setLoading(false)` во всех случаях
- ✅ Добавлены console.error для отладки
- ✅ Улучшена обработка ошибок в `handleRemoveAdmin()`

### 3. Как это работает

**До исправления:**
- RLS политика разрешала только обновление собственного профиля
- Админ не мог изменить роль другого пользователя

**После исправления:**
- Добавлена новая политика "Admins can update user roles"
- Проверяется, что текущий пользователь имеет role='ADMIN'
- Если да, разрешается обновление любого профиля

### 4. Real-time обновления

Real-time обновления списка администраторов уже были реализованы через:
```typescript
const channel = supabase
  .channel('admin-profiles-changes')
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'profiles',
    filter: 'role=eq.ADMIN'
  }, () => {
    loadAdmins();
  })
  .subscribe();
```

После применения миграции список администраторов будет обновляться автоматически при изменениях.

### 5. Проверка работоспособности

1. Войдите в админ-панель под учетной записью администратора
2. Перейдите в "Настройки" → "Управление администраторами"
3. Введите email существующего пользователя
4. Нажмите "Добавить"
5. Список администраторов должен обновиться мгновенно
6. Проверьте в БД, что роль изменилась на 'ADMIN'

### 6. Отладка

Если возникают проблемы, откройте консоль браузера (F12) и проверьте логи:
- `Error fetching profile:` - проблема с поиском пользователя
- `Error updating role:` - проблема с обновлением роли (возможно, RLS политика не применена)

## Миграция БД (содержимое)

```sql
-- Policy: Admins can update user roles
CREATE POLICY "Admins can update user roles"
  ON profiles
  FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'ADMIN'
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'ADMIN'
    )
  );
```

## Готово!

После применения миграции и пересборки проекта функционал добавления/удаления администраторов должен работать корректно.
